from .. import loader
import os
import re
import urllib.parse


@loader.tds
class AmeChangeLoaderText(loader.Module):
    """–ú–æ–¥—É–ª—å –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ –±–∞–Ω–Ω–µ—Ä–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞."""

    strings = {"name": "AmeChangeLoaderText"}

    # –î–æ–±–∞–≤–∏–º —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    PLACEHOLDERS = {
        "version": "'.'.join(map(str, version))",
        "build": "build",
        "build_hash": "build[:7]",
        "upd": "upd",
        "web_url": "web_url"
    }

    async def updateloadercmd(self, message):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∏ –±–∞–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑—á–∏–∫–∞."""
        args = message.raw_text.split(" ", 3)

        if len(args) == 1:
            await message.edit(
                "<b>üìã –°–ø—Ä–∞–≤–∫–∞ –ø–æ AmeChangeLoaderText:</b>\n\n"
                "‚Ä¢ <code>.updateloader reset hikari</code> - –°–±—Ä–æ—Å –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º Hikka\n"
                "‚Ä¢ <code>.updateloader reset coddrago</code> - –°–±—Ä–æ—Å –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º CodDrago\n"
                "‚Ä¢ <code>.updateloader https://site.com/banner.mp4</code> - –ó–∞–º–µ–Ω–∏—Ç—å –±–∞–Ω–Ω–µ—Ä\n"
                "‚Ä¢ <code>.updateloader —Ç–µ–∫—Å—Ç</code> - –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç\n"
                "‚Ä¢ <code>.updateloader —Ç–µ–∫—Å—Ç —Å placeholder</code> - –ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:\n"
                "   {version} - –≤–µ—Ä—Å–∏—è\n"
                "   {build} - –ø–æ–ª–Ω—ã–π –±–∏–ª–¥\n"
                "   {build_hash} - –∫–æ—Ä–æ—Ç–∫–∏–π —Ö–µ—à –±–∏–ª–¥–∞\n"
                "   {upd} - —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è\n"
                "   {web_url} - –≤–µ–±-URL\n\n"
                "–ü—Ä–∏–º–µ—Ä—ã:\n"
                "<code>.updateloader –ê–ø–¥–µ–π—Ç {upd} | –í–µ—Ä—Å–∏—è {version}</code>\n"
                "<code>.updateloader –ë–∏–ª–¥ {build_hash} –°—Ç–∞—Ç—É—Å {upd} –í–µ–± {web_url}</code>\n\n"
            )
            return
        try:
            main_file_path = os.path.join("hikka", "main.py")
            with open(main_file_path, "r", encoding="utf-8") as f:
                content = f.read()

            if args[1] == "reset":
                reset_type = args[2]
                if reset_type == "hikari":
                    url = "https://github.com/hikariatama/assets/raw/master/hikka_banner.mp4"
                    repo_link = "https://github.com/hikariatama/Hikka"
                elif reset_type == "coddrago":
                    url = "https://x0.at/pYQV.mp4"
                    repo_link = "https://github.com/coddrago/Hikka"
                else:
                    raise ValueError(
                        "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Å–±—Ä–æ—Å–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ hikari –∏–ª–∏ coddrago"
                    )

                animation_pattern = r'(await client\.hikka_inline\.bot\.send_animation\([^,]+,\s*)(["\']https://[^"\']+\.mp4["\'])'
                content = re.sub(animation_pattern, rf'\1"{url}"', content)

                # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞
                placeholder_defs = []
                for name, value in self.PLACEHOLDERS.items():
                    placeholder_defs.append(f"{name}={value}")
                
                caption = (
                    'caption=(\n                    f"üåò <b>Hikka {version} started!</b>\\n\\n'
                    'üå≥ <b>GitHub commit SHA: <a href=\\"{}/commit/{build_hash}\\">{build_hash}</a></b>\\n'
                    '‚úä <b>Update status: {upd}</b>\\n<b>{web_url}</b>",\n'
                    f'                    {",".join(placeholder_defs)}\n'
                    "                ),"
                ).format(repo_link)

                content = re.sub(r"caption=\([\s\S]*?\),", caption, content)
                result_message = f"‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ {reset_type}"
            elif self._is_valid_url(args[1]):
                animation_pattern = r'(await client\.hikka_inline\.bot\.send_animation\([^,]+,\s*)(["\']https://[^"\']+\.mp4["\'])'
                content = re.sub(animation_pattern, rf'\1"{args[1]}"', content)
                result_message = f"‚úÖ –ë–∞–Ω–Ω–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: <code>{args[1]}</code>"
            else:
                user_text = re.escape(args[1])
                has_placeholders = any(x in args[1] for x in [f"{{{k}}}" for k in self.PLACEHOLDERS.keys()])
                
                if has_placeholders:
                    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
                    used_placeholders = []
                    for name in self.PLACEHOLDERS.keys():
                        if f"{{{name}}}" in args[1]:
                            used_placeholders.append(f"{name}={self.PLACEHOLDERS[name]}")
                    
                    custom_text = (
                        'caption=(\n                    f"'
                        + user_text
                        + '",\n'
                        + "                    " + ",\n                    ".join(used_placeholders) + "\n"
                        + "                ),"
                    )
                else:
                    custom_text = (
                        'caption=(\n                    f"'
                        + user_text
                        + '"\n                ),'
                    )
                
                content = re.sub(r"caption=\([\s\S]*?\),", custom_text, content)
                result_message = f"‚úÖ –¢–µ–∫—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: <code>{args[1]}</code>"

            with open(main_file_path, "w", encoding="utf-8") as f:
                f.write(content)
            await message.edit(f"{result_message}\n–ù–∞–ø–∏—à–∏—Ç–µ <code>.restart -f</code>")
        except Exception as e:
            await message.edit(f"‚ùå –û—à–∏–±–∫–∞: <code>{e}</code>")

    def _is_valid_url(self, url):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ URL –≤–∞–ª–∏–¥–Ω—ã–º –∏ –æ–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ .mp4."""
        try:
            result = urllib.parse.urlparse(url)
            return all([result.scheme, result.netloc]) and url.endswith(".mp4")
        except:
            return False
